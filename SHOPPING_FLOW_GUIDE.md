# ğŸ›ï¸ HÆ¯á»šNG DáºªN FLOW MUA HÃ€NG HOÃ€N CHá»ˆNH

**NgÃ y cáº­p nháº­t:** 7 thÃ¡ng 1, 2026

---

## ğŸ“‹ Tá»”NG QUAN FLOW

Flow mua hÃ ng Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ táº¡o tráº£i nghiá»‡m mÆ°á»£t mÃ  tá»« khi khÃ¡ch hÃ ng chá»n sáº£n pháº©m Ä‘áº¿n khi hoÃ n táº¥t Ä‘Æ¡n hÃ ng.

### ğŸ¯ Má»¥c tiÃªu:
1. âœ… Há»i sá»‘ lÆ°á»£ng khi khÃ¡ch muá»‘n mua
2. âœ… TÃ­nh toÃ¡n vÃ  hiá»ƒn thá»‹ chi tiáº¿t giÃ¡
3. âœ… Äá» xuáº¥t vÃ  Ã¡p dá»¥ng mÃ£ giáº£m giÃ¡
4. âœ… Tá»± Ä‘á»™ng thÃªm vÃ o giá» vá»›i Ä‘Ãºng thÃ´ng tin
5. âœ… Chuyá»ƒn Ä‘áº¿n trang thanh toÃ¡n vá»›i chá»‰ sáº£n pháº©m Ä‘Ã£ chá»n
6. âœ… Cáº£m Æ¡n vÃ  há»i kiá»ƒm tra Ä‘Æ¡n hÃ ng sau khi Ä‘áº·t

---

## ğŸ”„ CHI TIáº¾T Tá»ªNG BÆ¯á»šC

### BÆ¯á»šC 1ï¸âƒ£: KHÃCH NÃ“I MUA Sáº¢N PHáº¨M

**Input tá»« khÃ¡ch:**
```
"mua iPhone 15"
"cho tÃ´i xem iPad Pro"
"tÃ´i muá»‘n mua MacBook Air"
```

**AI Response:**
```
TÃ´i sáº½ giÃºp báº¡n mua [TÃªn sáº£n pháº©m] nhÃ©!

ğŸ“¦ Sáº£n pháº©m: [TÃªn Ä‘áº§y Ä‘á»§]
ğŸ’° GiÃ¡: [GiÃ¡]Ä‘
ğŸ–¼ï¸ ![áº¢nh sáº£n pháº©m](URL)

ğŸ” ThÃ´ng sá»‘ ká»¹ thuáº­t ná»•i báº­t:
- [Spec 1]
- [Spec 2]
- [Spec 3]

â“ Báº¡n muá»‘n mua bao nhiÃªu chiáº¿c?
```

**LÆ°u Ã½:**
- Hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ thÃ´ng tin sáº£n pháº©m
- Há»i sá»‘ lÆ°á»£ng má»™t cÃ¡ch tá»± nhiÃªn
- KhÃ´ng tá»± Ä‘á»™ng add vÃ o giá» ngay

---

### BÆ¯á»šC 2ï¸âƒ£: KHÃCH TRáº¢ Lá»œI Sá» LÆ¯á»¢NG

**Input tá»« khÃ¡ch:**
```
"2 chiáº¿c"
"3 cÃ¡i"
"1 mÃ¡y"
"5"
```

**AI Response:**
```
Tuyá»‡t vá»i! Äá»ƒ tÃ´i tÃ­nh toÃ¡n cho báº¡n:

ğŸ“¦ Sáº£n pháº©m: [TÃªn sáº£n pháº©m]
ğŸ”¢ Sá»‘ lÆ°á»£ng: [X] chiáº¿c
ğŸ’° ÄÆ¡n giÃ¡: [GiÃ¡]Ä‘/chiáº¿c
ğŸ’µ Tá»•ng tiá»n: [Tá»•ng]Ä‘

ğŸ Báº¡n cÃ³ muá»‘n sá»­ dá»¥ng mÃ£ giáº£m giÃ¡ khÃ´ng?
ChÃºng tÃ´i cÃ³ cÃ¡c mÃ£ sau:

[Hiá»ƒn thá»‹ nÃºt cho má»—i mÃ£ giáº£m giÃ¡]
```

**Actions hiá»ƒn thá»‹:**
- âœ… NÃºt "ğŸ« Ãp mÃ£ [CODE]" cho tá»«ng mÃ£ giáº£m giÃ¡
- âœ… NÃºt "â­ï¸ Bá» qua, thanh toÃ¡n luÃ´n"

---

### BÆ¯á»šC 3ï¸âƒ£: KHÃCH CHá»ŒN MÃƒ GIáº¢M GIÃ (hoáº·c bá» qua)

#### TrÆ°á»ng há»£p A: KhÃ¡ch chá»n mÃ£

**Input tá»« khÃ¡ch:**
```
Click nÃºt "ğŸ« Ãp mÃ£ SAVE10"
hoáº·c nÃ³i: "dÃ¹ng mÃ£ SAVE10"
```

**AI Response:**
```
Tuyá»‡t vá»i! MÃ£ SAVE10 Ä‘Ã£ Ä‘Æ°á»£c Ã¡p dá»¥ng:

ğŸ“¦ Sáº£n pháº©m: [TÃªn sáº£n pháº©m] x [SL]
ğŸ’° Tá»•ng tiá»n gá»‘c: [Tá»•ng gá»‘c]Ä‘
ğŸ« MÃ£ giáº£m giÃ¡: SAVE10 (-10%)
ğŸ’µ Giáº£m giÃ¡: -[Sá»‘ tiá»n giáº£m]Ä‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Tá»•ng thanh toÃ¡n: [Tá»•ng sau giáº£m]Ä‘

ğŸ’³ Báº¡n cÃ³ muá»‘n thanh toÃ¡n ngay khÃ´ng?
```

#### TrÆ°á»ng há»£p B: KhÃ¡ch bá» qua

**AI Response:**
```
ÄÆ°á»£c rá»“i! Tá»•ng Ä‘Æ¡n hÃ ng cá»§a báº¡n:

ğŸ“¦ Sáº£n pháº©m: [TÃªn sáº£n pháº©m] x [SL]
ğŸ’µ Tá»•ng thanh toÃ¡n: [Tá»•ng]Ä‘

ğŸ’³ Báº¡n cÃ³ muá»‘n thanh toÃ¡n ngay khÃ´ng?
```

**Actions hiá»ƒn thá»‹:**
- âœ… NÃºt "ğŸ’³ Thanh toÃ¡n ngay"
- âœ… NÃºt "ğŸ›’ Xem giá» hÃ ng"

---

### BÆ¯á»šC 4ï¸âƒ£: KHÃCH XÃC NHáº¬N THANH TOÃN

**Input tá»« khÃ¡ch:**
```
Click "ğŸ’³ Thanh toÃ¡n ngay"
hoáº·c nÃ³i: "cÃ³", "thanh toÃ¡n", "Ä‘á»“ng Ã½"
```

**Há»‡ thá»‘ng thá»±c hiá»‡n (Backend):**
1. âœ… Tá»± Ä‘á»™ng thÃªm sáº£n pháº©m vÃ o giá» hÃ ng vá»›i sá»‘ lÆ°á»£ng Ä‘Ã£ chá»n
2. âœ… Tá»± Ä‘á»™ng Ã¡p dá»¥ng mÃ£ giáº£m giÃ¡ (náº¿u cÃ³)
3. âœ… Clear cÃ¡c sáº£n pháº©m khÃ¡c trong giá» (náº¿u cáº§n)
4. âœ… Hiá»ƒn thá»‹ action "GO_TO_CHECKOUT"

**AI Response:**
```
ÄÃ£ thÃªm [X] [TÃªn sáº£n pháº©m] vÃ o giá» hÃ ng [vá»›i mÃ£ giáº£m giÃ¡ CODE]!

ğŸ“¦ Sáº£n pháº©m: [TÃªn] x [SL]
[ğŸ« MÃ£ giáº£m giÃ¡: CODE]
ğŸ’µ Tá»•ng thanh toÃ¡n: [Tá»•ng]Ä‘

ğŸ‘‡ Vui lÃ²ng nháº¥n nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ hoÃ n táº¥t Ä‘Æ¡n hÃ ng.
```

**Actions hiá»ƒn thá»‹:**
- âœ… NÃºt "ğŸ’³ Äi tá»›i trang thanh toÃ¡n" â†’ Chuyá»ƒn Ä‘áº¿n `/checkout`

---

### BÆ¯á»šC 5ï¸âƒ£: SAU KHI THANH TOÃN XONG

**Khi khÃ¡ch quay láº¡i chat sau khi thanh toÃ¡n:**

**AI Response (tá»± Ä‘á»™ng):**
```
ğŸ‰ Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘áº·t hÃ ng táº¡i [TÃªn shop]!

âœ… ÄÆ¡n hÃ ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c ghi nháº­n vÃ  Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½.

ğŸ“¦ ThÃ´ng tin Ä‘Æ¡n hÃ ng:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Sáº£n pháº©m: [TÃªn] x [SL]
[â€¢ MÃ£ giáº£m giÃ¡: CODE]
â€¢ Tá»•ng thanh toÃ¡n: [Tá»•ng]Ä‘
â€¢ Tráº¡ng thÃ¡i: Äang xá»­ lÃ½

ğŸ“± Báº¡n cÃ³ muá»‘n kiá»ƒm tra chi tiáº¿t Ä‘Æ¡n hÃ ng vá»«a Ä‘áº·t khÃ´ng?
```

**Actions hiá»ƒn thá»‹:**
- âœ… NÃºt "ğŸ“¦ Xem Ä‘Æ¡n hÃ ng cá»§a tÃ´i"
- âœ… NÃºt "ğŸ›ï¸ Tiáº¿p tá»¥c mua sáº¯m"

---

### BÆ¯á»šC 6ï¸âƒ£: KHÃCH KIá»‚M TRA ÄÆ N HÃ€NG

**Input tá»« khÃ¡ch:**
```
Click "ğŸ“¦ Xem Ä‘Æ¡n hÃ ng cá»§a tÃ´i"
hoáº·c nÃ³i: "cÃ³", "kiá»ƒm tra Ä‘Æ¡n hÃ ng"
```

**AI Response:**
```
ÄÃ¢y lÃ  danh sÃ¡ch Ä‘Æ¡n hÃ ng cá»§a báº¡n:

ğŸ“‹ ÄÆ¡n hÃ ng #[ID] - [NgÃ y]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ Sáº£n pháº©m: [TÃªn] x [SL]
ğŸ’µ Tá»•ng tiá»n: [Tá»•ng]Ä‘
ğŸ“ Tráº¡ng thÃ¡i: [Tráº¡ng thÃ¡i]

Báº¡n cÃ³ cáº§n há»— trá»£ gÃ¬ thÃªm khÃ´ng?
```

**Actions hiá»ƒn thá»‹:**
- âœ… NÃºt "ğŸ“¦ Xem táº¥t cáº£ Ä‘Æ¡n hÃ ng"

---

## âš™ï¸ IMPLEMENTATION DETAILS

### 1. Backend Logic (groq_chat.py)

#### System Prompt Ä‘Ã£ cáº­p nháº­t:
```python
# ÄÃ£ thÃªm section "ğŸ›ï¸ FLOW MUA HÃ€NG HOÃ€N CHá»ˆNH"
# Lines 850-920 trong groq_chat.py
```

#### Action Detection:
```python
def detect_action_intent(message, products, discounts, ai_response):
    # Detect ADD_TO_CART intent
    # Detect APPLY_DISCOUNT intent  
    # Detect GO_TO_CHECKOUT intent
    # Detect CHECK_ORDERS intent
```

### 2. Frontend Actions (ai-chat/page.tsx)

#### Action Handlers:
```typescript
// GO_TO_CHECKOUT
router.push('/checkout');

// APPLY_DISCOUNT
// Apply discount code to cart

// CHECK_ORDERS
router.push('/orders');
```

### 3. ChromaDB Sync

**Cart Sync (sync_management.py):**
```python
async def sync_cart(chroma_service, data):
    # Sync cart vá»›i items_json
    # Store: productId, productName, quantity, price, subtotal
```

**Discount Context:**
```python
def get_discount_context(query):
    # Retrieve available discount codes
    # Filter by validity date
```

---

## ğŸ§ª TEST SCENARIOS

### Test Case 1: Flow hoÃ n chá»‰nh vá»›i mÃ£ giáº£m giÃ¡
```
User: "mua iPhone 15"
AI: [Há»i sá»‘ lÆ°á»£ng]

User: "2 chiáº¿c"
AI: [TÃ­nh toÃ¡n, há»i mÃ£ giáº£m giÃ¡]

User: Click "Ãp mÃ£ SAVE10"
AI: [Hiá»ƒn thá»‹ tá»•ng sau giáº£m, há»i thanh toÃ¡n]

User: "thanh toÃ¡n"
AI: [ThÃªm vÃ o giá», chuyá»ƒn checkout]

â†’ Verify: Giá» hÃ ng cÃ³ 2 iPhone 15 vá»›i mÃ£ SAVE10
â†’ Verify: Trang checkout hiá»ƒn thá»‹ Ä‘Ãºng
```

### Test Case 2: KhÃ´ng dÃ¹ng mÃ£ giáº£m giÃ¡
```
User: "mua MacBook"
AI: [Há»i sá»‘ lÆ°á»£ng]

User: "1"
AI: [TÃ­nh toÃ¡n, há»i mÃ£ giáº£m giÃ¡]

User: "khÃ´ng cáº§n"
AI: [Há»i thanh toÃ¡n]

User: "cÃ³"
AI: [ThÃªm vÃ o giá», chuyá»ƒn checkout]

â†’ Verify: Giá» hÃ ng cÃ³ 1 MacBook, khÃ´ng cÃ³ mÃ£ giáº£m giÃ¡
```

### Test Case 3: Sau khi thanh toÃ¡n
```
User: [Quay láº¡i chat sau checkout]
AI: [Cáº£m Æ¡n, há»i kiá»ƒm tra Ä‘Æ¡n hÃ ng]

User: "cÃ³"
AI: [Hiá»ƒn thá»‹ Ä‘Æ¡n hÃ ng vá»«a Ä‘áº·t]

â†’ Verify: ÄÆ¡n hÃ ng hiá»ƒn thá»‹ Ä‘Ãºng thÃ´ng tin
```

---

## ğŸ“Š METRICS & TRACKING

### Conversion Tracking:
1. **Step 1 â†’ Step 2:** % khÃ¡ch tráº£ lá»i sá»‘ lÆ°á»£ng
2. **Step 2 â†’ Step 3:** % khÃ¡ch chá»n/bá» qua mÃ£ giáº£m giÃ¡
3. **Step 3 â†’ Step 4:** % khÃ¡ch xÃ¡c nháº­n thanh toÃ¡n
4. **Step 4 â†’ Step 5:** % hoÃ n táº¥t checkout
5. **Step 5 â†’ Step 6:** % kiá»ƒm tra Ä‘Æ¡n hÃ ng

### Log Events:
```python
# Log má»—i bÆ°á»›c trong flow
logger.info(f"[SHOPPING_FLOW] User {user_id} - Step 1: Product selected")
logger.info(f"[SHOPPING_FLOW] User {user_id} - Step 2: Quantity: {qty}")
logger.info(f"[SHOPPING_FLOW] User {user_id} - Step 3: Discount: {code}")
logger.info(f"[SHOPPING_FLOW] User {user_id} - Step 4: Checkout initiated")
logger.info(f"[SHOPPING_FLOW] User {user_id} - Step 5: Order completed")
```

---

## âš ï¸ EDGE CASES

### 1. Sáº£n pháº©m háº¿t hÃ ng:
```
AI: "Ráº¥t tiáº¿c, [TÃªn sáº£n pháº©m] hiá»‡n Ä‘ang háº¿t hÃ ng.
     Tá»“n kho: 0 chiáº¿c
     
     Báº¡n cÃ³ muá»‘n xem sáº£n pháº©m tÆ°Æ¡ng tá»± khÃ´ng?"
```

### 2. Sá»‘ lÆ°á»£ng vÆ°á»£t quÃ¡ tá»“n kho:
```
AI: "Xin lá»—i, chÃºng tÃ´i chá»‰ cÃ²n [X] chiáº¿c [TÃªn sáº£n pháº©m].
     Báº¡n cÃ³ muá»‘n mua [X] chiáº¿c khÃ´ng?"
```

### 3. MÃ£ giáº£m giÃ¡ háº¿t háº¡n:
```
AI: "MÃ£ [CODE] Ä‘Ã£ háº¿t háº¡n sá»­ dá»¥ng.
     Báº¡n cÃ³ muá»‘n xem cÃ¡c mÃ£ khÃ¡c khÃ´ng?"
```

### 4. KhÃ¡ch khÃ´ng tráº£ lá»i sá»‘ lÆ°á»£ng:
```
[Sau 30s khÃ´ng response]
AI: "Báº¡n váº«n quan tÃ¢m Ä‘áº¿n [TÃªn sáº£n pháº©m] chá»©?
     Äá»ƒ tÃ´i giÃºp báº¡n, báº¡n muá»‘n mua bao nhiÃªu chiáº¿c?"
```

---

## ğŸ¯ SUCCESS CRITERIA

âœ… **Flow mÆ°á»£t mÃ :** KhÃ¡ch khÃ´ng bá»‹ giÃ¡n Ä‘oáº¡n  
âœ… **ThÃ´ng tin Ä‘áº§y Ä‘á»§:** Má»i chi tiáº¿t Ä‘Æ°á»£c hiá»ƒn thá»‹ rÃµ rÃ ng  
âœ… **Tá»± Ä‘á»™ng hÃ³a:** Giáº£m thiá»ƒu input tá»« khÃ¡ch  
âœ… **ChÃ­nh xÃ¡c:** Giá» hÃ ng chá»‰ chá»©a Ä‘Ãºng sáº£n pháº©m Ä‘Ã£ chá»n  
âœ… **Discount:** MÃ£ giáº£m giÃ¡ Ä‘Æ°á»£c Ã¡p dá»¥ng Ä‘Ãºng  
âœ… **Follow-up:** Cáº£m Æ¡n vÃ  há»— trá»£ sau mua hÃ ng  

---

**LÆ°u Ã½:** Flow nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ tá»‘i Æ°u conversion rate vÃ  customer experience. Má»i thay Ä‘á»•i cáº§n test ká»¹ trÆ°á»›c khi deploy.
